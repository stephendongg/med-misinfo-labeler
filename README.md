# MedCheck: Automated Drug Claim Verification Using FDA Labeling  

Automated labeling system for Bluesky that detects drug mentions, verifies FDA approval status, and fact-checks medical indication claims against public FDA data.

**Group Number:** 13  
**Group Members:** Viha Srinivas, Zhiming Zhang, Samantha Wu, Stephen Dong

---

## Quick Setup
```bash
git clone https://github.com/<your-username>/med-misinfo-labeler
cd med-misinfo-labeler
python -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt
cp .env-TEMPLATE .env
# Edit .env: add OPENAI_API_KEY, USERNAME, PW
```


## Repository Structure

```
med-misinfo-labeler/
├── analysis/              # Analysis notebooks
│   ├── analysis.ipynb   
│   ├── inputs/            # Manual labels for reliability analysis
│   │   └── labels_*.csv   # Independent labels from each rater
│   └── outputs/           # Analysis outputs
│       └── error_analysis.csv
├── output/                # Generated files (auto-created)
│   ├── moderation_log.csv
│   └── labeled_set.csv
├── pylabel/               # Core implementation
│   ├── __init__.py
│   ├── policy_proposal_labeler.py
│   ├── claim_checker.py
│   ├── fda_lookup.py
│   └── label.py
├── test-data/             # Test datasets
│   ├── by_category/
│   └── *.csv
├── data.csv               # Main test file
├── test_labeler.py        # Main test script
├── requirements.txt
├── README.md
└── .env-TEMPLATE
```

## Files

### Core Implementation
- `pylabel/policy_proposal_labeler.py` - Main `PolicyProposalLabeler` class with moderation pipeline
- `pylabel/label.py` - Bluesky API utilities (post fetching, label application, DID resolution)
- `pylabel/claim_checker.py` - Claim extraction and fact-checking against FDA labeling
- `pylabel/fda_lookup.py` - FDA drug approval and labeling lookup via OpenFDA API
- `pylabel/__init__.py` - Package initialization

### Testing & Data
- `test_labeler.py` - Test harness for running labeler on CSV files
- `data.csv` - **Main evaluation dataset** (~150 posts) combining real Bluesky posts and generated examples
- `test-data/` - Development and categorized test files:
  - `input-drug-real.csv` - Real Bluesky posts with drug mentions
  - `input-drug-generated.csv` - Generated test posts
  - `by_category/` - Test cases organized by label category (approved, unapproved, supported/unsupported claims, irrelevant)
- `analysis/` - Analysis notebooks for evaluation and metrics

### Output Files
- `output/moderation_log.csv` - Detailed log of labeling decisions (auto-generated when running tests)
- `output/labeled_set.csv` - Example copy of moderation_log.csv showing results from running labeler on `data.csv`
- `analysis/outputs/error_analysis.csv` - Error analysis dataset (generated by analysis notebook)

---

## Running Tests

### Basic Usage
```bash
python test_labeler.py <input-csv-file> [--emit_labels]
```

**Note:** By default, labels are NOT emitted to Bluesky. Use `--emit_labels` flag only when you want to actually apply labels to posts on the network.

### Running Evaluation Dataset
To run the evaluation on the required test dataset:
```bash
python test_labeler.py data.csv
```

### CSV Format
Files should have `URL` or `Text` column (or both) and a `Labels` column with JSON array format:
```csv
URL,Text,Labels
https://bsky.app/profile/example/post/123,,"[""drug-approved"",""supported-claim""]"
,Just picked up my metformin prescription.,"[""drug-approved""]"
```

**Note:** If both columns are present, the script will use whichever has a value (Text is checked first, then URL).

### Expected Output
The script prints:
- Number of correct label assignments
- Overall accuracy ratio

Detailed results (including timestamps, detected drugs, claims, performance metrics) are logged to `output/moderation_log.csv`.

### Evaluation
Use `analysis/analysis.ipynb` to analyze the results from `output/moderation_log.csv` and calculate detailed metrics (precision, recall, F1-score, error analysis, etc.). Generates `analysis/outputs/error_analysis.csv`.

---

## Implementation Overview

### Labels Generated
- `drug-approved` - Post mentions FDA-approved drug(s)
- `drug-unapproved` - Post mentions unapproved/unrecognized drug(s)
- `supported-claim` - Indication claim (what condition drug treats) is verified against FDA-approved indications
- `unsupported-claim` - Indication claim cannot be verified against FDA-approved indications

### Pipeline
1. **Drug Detection** - Uses LLM to identify drug mentions in posts with confidence scoring
2. **FDA Verification** - Checks detected drugs against FDA approval database (OpenFDA API)
3. **Claim Extraction** - Identifies indication claims (what condition(s) the drug treats) from post text
4. **Fact Checking** - Verifies extracted indication claims against FDA-approved indications using LLM

**Note:** Currently, the system only checks indication claims (what conditions drugs treat), not other types of claims such as dosage, side effects, or drug interactions.

### Key Functions

**Main API (`pylabel/policy_proposal_labeler.py`):**
- `PolicyProposalLabeler.moderate_post(url=None, text=None)` - Main function that takes a Bluesky post URL or text and returns list of labels

**Supporting Modules:**
- `pylabel/claim_checker.py` - Claim extraction and fact-checking against FDA labeling
- `pylabel/fda_lookup.py` - FDA drug approval and labeling lookup via OpenFDA API  
- `pylabel/label.py` - Bluesky API utilities for fetching posts and applying labels

---

## Project Links
- [Project Report](https://docs.google.com/document/d/1rQrgdzop-6PgfUXK8_p0n2VOfUJENYwo3zitkWgu_rY/edit?tab=t.d7v4umxe1ygp)
- [Project Drive](https://drive.google.com/drive/u/0/folders/1jaiOBhk-5XAITQL_i_6qKUUg01tlnjVd)
- [Assignment Doc](https://docs.google.com/document/d/1rQrgdzop-6PgfUXK8_p0n2VOfUJENYwo3zitkWgu_rY/edit?tab=t.jl6mduu0sudz)
- [Policy Proposal](https://docs.google.com/document/d/1f-2VSGjHfFOUZXSHIMBSCVEWm4NRnzjaj4kAB7C3mjw/edit?tab=t.jzvd2wwrer9s)
- [Figma Mockup](https://www.figma.com/board/BnyKzCTUETXypsjbL3RYUs/Med-Misinfo-Labeler?node-id=0-1&t=QKd7iegx3bDecWRm-1)

### Resources
- [AT Protocol SDK](https://atproto.blue/en/latest/)


